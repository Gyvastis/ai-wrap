name: api

on:
  push:
    branches: [main]
    paths:
      - '**'
      - '!app/**'
      - '!.github/workflows/app.yml'
      - '!*.md'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'skip tests'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    if: "!inputs.skip_tests"

    steps:
      - uses: actions/checkout@v4

      - name: setup go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: go.sum

      - name: install dependencies
        run: go mod download

      - name: start services
        run: docker compose up -d --wait

      - name: wait for air build and server startup
        run: |
          echo "Waiting for air to build and server to start..."
          for i in {1..60}; do
            if curl -sf http://localhost:8089/health > /dev/null 2>&1; then
              echo "Server is ready!"
              exit 0
            fi
            echo "Attempt $i/60: Server not ready yet..."
            sleep 2
          done
          echo "Server failed to become ready after 120 seconds"
          docker compose logs ai-wrap
          exit 1

      - name: run tests
        run: go test -v ./tests

      - name: show container logs on failure
        if: failure()
        run: docker compose logs ai-wrap

      - name: stop services
        if: always()
        run: docker compose down

  docker:
    runs-on: ubuntu-latest
    needs: test
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: set up docker buildx
        uses: docker/setup-buildx-action@v3

      - name: login to docker hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: build and push api image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: gyvastis/ai-wrap-api:latest
          provenance: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
